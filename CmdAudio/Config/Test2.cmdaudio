

generator Drum() = {
  state noteLength = 0.05;
  state decaySaw = Saw( Time: noteLength );
  state noteTrigger = Pulse( Time: noteLength );

  state decay = Lerp( value: decaySaw, min:1, max: 0 );
  state noise = Noise();
  state prefiltered = noise * decay;

  state filter = FilterLadder(in: prefiltered, frequency: 2600, resonance: 3.0 );
  state out = noteTrigger * filter;

  output out;
}


generator NoteRelease( ) = {

  state releaseSaw = Lerp( value: Saw( Frequency: 1.0 ), min: 1, max: 0 );
  state release = releaseSaw * Pulse( Frequency: 1.0 );

  output release;
}

// ramp that starts at 0 and ends at 1 in 'time'
generator Ramp2(time) = {
    state attackSaw = Saw( Frequency: 1 );

output attackSaw;
}


generator Note(freq, noteon) = {
  state beep = Sine( Frequency: freq );

  state sustainLevel = 0.125;

  state attackSaw = Saw( Frequency: 1 );
  state attack = Lerp( value: attackSaw, min:0, max: 1 ) * Pulse( Frequency: 1.0 );

  state decaySaw = Saw( Frequency: 1.0 );
  state decay = Lerp( value: decaySaw, min:1, max: sustainLevel ) * Pulse( Frequency: 1 );
  state decayDelayed = Delay( delay: 22050, duration: 11025, in: decay );

  state sustain = sustainLevel * Pulse( Frequency: 1 );
  state sustainDelayed = Delay( delay: 44100, duration: 11025, in: sustain );

  state onramp = attack + decayDelayed + sustainDelayed;
  state noteonInv = Lerp( value: noteon, min:1, max: 0 );
  state onheld = Hold( in: onramp, hold: noteon);//noteonInv );

  state releaseTrigger = Lerp( value: noteon, min:2, max:0 );
state releaseEnv = NoteRelease( reset: releaseTrigger ) + noteon;

state out =  beep * onheld * releaseEnv;

  output out;
}


generator TestInternal() = {
state pulse = Sine( Frequency: 500 );
output pulse;
}

generator TestReset( test ) = {
state out = TestInternal( reset: test );
output out;
}

generator Main(time) = {
  state drumTrigger = Saw( Frequency: 2 );
//state out = Sine(Frequency:440.0) * Pulse( Frequency: 1.0 );

  state notetrigger = Pulse( Frequency: 0.8 );
  state note = Note( freq: 500.0, noteon: notetrigger );

//state notetrigger = Saw( Frequency: 1.0 );
//state out = TestReset( test: notetrigger );

  state drum = Drum(reset: drumTrigger);
  state out = drum + note;

  output drum;
}
